name: CI Pipeline

on:
  push:
    branches:
      - main
      - develop

  pull_request:
    branches:
      - main
      - develop

jobs:
  build:
    name: ğŸ— Build Container
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ñ
        uses: actions/checkout@v4

      - name: ğŸ³ Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° Docker-Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ°
        run: |
          docker build -t backend_app .

  docker-compose:
    name: ğŸš€ Run Docker Compose
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: ğŸ“¥ Checkout Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ñ
        uses: actions/checkout@v4

      - name: ğŸ³ Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Docker Compose
        run: sudo apt-get update && sudo apt-get install -y docker-compose

      - name: ğŸ”¥ Ğ—Ğ°Ğ¿ÑƒÑĞº `docker-compose`
        run: docker-compose up -d

      - name: â³ ĞĞ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ° ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²
        run: sleep 10

      - name: ğŸ” ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° API `/api/v1/ping`
        run: |
          for i in {1..5}; do
            if curl -sSf http://localhost:8080/api/v1/ping; then
              echo "âœ… API Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½!"
              exit 0
            fi
            echo "â³ ĞĞ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ğµ ÑĞµÑ€Ğ²Ğ¸ÑĞ°..."
            sleep 5
          done
          echo "âŒ API Ğ½Ğµ Ğ¾Ñ‚Ğ²ĞµÑ‡Ğ°ĞµÑ‚!"
          exit 1

  generate-swagger:
    name: ğŸ“œ Generate Swagger Docs
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: ğŸ“¥ Checkout Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ñ
        uses: actions/checkout@v4

      - name: ğŸ”§ Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Swag
        run: go install github.com/swaggo/swag/cmd/swag@latest

      - name: ğŸš€ Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ Swagger
        run: swag init -g cmd/backend/main.go -d .

      - name: ğŸ“¤ ĞšĞ¾Ğ¼Ğ¼Ğ¸Ñ‚ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ğ¾Ğ³Ğ¾ Swagger
        run: |
          git config --global user.email "github-actions@github.com"
          git config --global user.name "GitHub Actions"
          git add docs/
          git commit -m "ğŸ”„ ĞĞ²Ñ‚Ğ¾Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Swagger API" || echo "No changes to commit"
          git push origin main || echo "No changes to push"